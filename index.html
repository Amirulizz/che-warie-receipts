<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Che Warie D Katering - Receipt Generator</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Apple PWA Settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Receipts">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#4CAF50">
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 10pt;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    /* Tabs */
    .tabs {
      overflow: hidden;
      border-bottom: 1px solid #ccc;
      background: #474747;
      display: flex;
      width: 100%;
    }

    .tab-btn {
      background-color: inherit;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px 16px;
      font-size: 10pt;
      transition: 0.3s;
      border-radius: 8px 8px 0 0;
    }

    .tab-btn:hover {
      background-color: #a7a7a7;
    }

    .tab-btn.active {
      background-color: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 20px;
      animation: fadeEffect 0.5s;
      width: 100%;
      box-sizing: border-box;
    }

    @keyframes fadeEffect {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Generator Layout */
    .container {
      display: flex;
      gap: 20px;
      height: 90vh;
      overflow: hidden;
    }

    .form-section {
      width: 35%;
      max-height: 95vh;
      overflow-y: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .receipt-section {
      width: 65%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      padding: 10px;
    }

    #receipt {
      width: 210mm !important;
      min-height: 297mm !important;
      background: white;
      padding: 25.4mm;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      box-sizing: border-box;
      position: relative;
      font-family: Arial, sans-serif;
      font-size: 10pt;
    }
    .receipt-title[data-mode="quotation"] {
    color: #e91e63;
    }
    /* Document Type Labels */
    .doc-label {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 10pt;
      margin-left: 10px;
    }

    .doc-label.receipt {
      background-color: #d4edff;
      color: #004085;
    }

    .doc-label.quotation {
      background-color: #fff3cd;
      color: #856404;
    }
    @media (min-height: 1080px) and (min-width: 1920px) {
      .receipt-section {
        transform: scale(0.95);
        transform-origin: top center;
      }
    }

    label {
      display: block;
      margin: 6px 0 3px;
    }

    input, textarea, select {
      width: 100%;
      padding: 5px;
      margin-top: 2px;
      box-sizing: border-box;
      font-size: 10pt;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      margin-top: 8px;
      padding: 6px 12px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 10pt;
    }

    .danger-btn {
      background: #f44336;
    }

    /* Dashboard Styles */
    .dashboard-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .summary-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 200px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #ddd;
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 11pt;
      color: #333;
    }

    .card p {
      margin: 0;
      font-size: 14pt;
      font-weight: bold;
      color: #4CAF50;
    }

    #allReceiptsList li, #topItemsList li {
      margin: 5px 0;
      padding: 8px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    #allReceiptsList li:hover {
      background: #e0f7fa;
    }

    canvas {
      max-width: 100%;
      margin: 15px 0;
    }

    /* Dashboard PDF Styles */
    .dashboard-pdf {
      width: 210mm;
      min-height: 297mm;
      padding: 25.4mm;
      margin: 0 auto;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
      font-size: 10pt;
      background: white;
    }

    .dashboard-pdf h2 {
      text-align: center;
      font-size: 14pt;
      margin-bottom: 20px;
    }

    .dashboard-pdf .card {
      border: 1px solid #ddd;
      padding: 12px;
      margin: 10px 0;
      text-align: center;
    }

    .dashboard-pdf ul {
      list-style: none;
      padding: 0;
    }

    .dashboard-pdf li {
      padding: 6px;
      margin: 4px 0;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
    }

    /* Common Receipt Styles */
    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      width: 130px;
    }

    .company-details h2 {
      font-size: 10pt;
      margin: 0;
      color: #000;
    }

    .company-details p {
      margin: 2px 0;
    }

    .receipt-title {
      text-align: center;
      margin: 15px 0;
      font-size: 11pt;
      font-weight: bold;
    }

    .top-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .left-info, .right-info {
      width: 48%;
    }

    .payment-shipping {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
    }

    .payment-shipping div {
      text-align: center;
      flex: 1;
    }

    .items-table {
      width: 100% !important;
      border-collapse: collapse;
      margin: 12px 0;
      table-layout: fixed;
      page-break-inside: avoid;
    }

    .items-table th, .items-table td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
      word-wrap: break-word;
    }

    .items-table th {
      background: #f0f0f0;
      font-weight: bold;
    }

    .items-table img {
      max-width: 45px;
      height: auto;
      object-fit: contain;
      vertical-align: middle;
    }

    .totals {
      text-align: right;
      margin-top: 15px;
      font-size: 10pt;
    }

    .grand-total {
      font-weight: bold;
    }

    .footer {
      margin-top: 35px;
      text-align: center;
      page-break-inside: avoid;
    }

    .remarks {
      margin-top: 12px;
      padding: 8px;
      border: 1px dashed #aaa;
      font-style: italic;
    }

    details {
      margin-bottom: 12px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }

    summary {
      font-weight: bold;
      cursor: pointer;
    }

    /* Catalogue popup */
    #cataloguePopup {
      display: none;
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      max-height: 85vh;
      background: white;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      font-size: 10pt;
    }

    #cataloguePopup .close-btn {
      float: right;
      cursor: pointer;
      background: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
    }

    #catalogueGallery {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }

    #catalogueGallery div {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      width: 140px;
      border-radius: 6px;
      background: #f9f9f9;
    }

    #catalogueGallery img {
      max-width: 100%;
      height: 90px;
      object-fit: contain;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="openTab(event, 'generator')">üìÑ Receipt Generator</button>
  <button class="tab-btn" onclick="openTab(event, 'dashboard')">üìä Sales Dashboard</button>
</div>

<!-- Tab 1: Receipt Generator -->
<div id="generator" class="tab-content" style="display: block;">
  <div class="container">
    <!-- LEFT: Receipt Preview -->
    <div class="receipt-section">
      <div id="receipt">
        <div class="receipt-header">
          <img src="logo.png" alt="Company Logo" class="logo">
          <div class="company-details">
            <h2>Che Warie D Katering</h2>
            <p>002138764-M</p>
            <p>Jalan Kebun Seksyen 30<br>40460 Shah Alam<br>Selangor Darul Ehsan</p>
          </div>
        </div>
        <h1 class="receipt-title">RECEIPT</h1>
        <div class="top-info">
          <div class="left-info">
            <p><strong>Invoice No:</strong> <span id="rInvoiceNo"></span></p>
            <p><strong>Date:</strong> <span id="rInvoiceDate"></span></p>
          </div>
          <div class="right-info">
            <h3>Bill To:</h3>
            <p><strong>Name:</strong> <span id="rCustomerName"></span></p>
            <p><strong>Address:</strong> <span id="rCustomerAddress"></span></p>
            <p><strong>Tel:</strong> <span id="rCustomerTel"></span></p>
            <p><strong>Email:</strong> <span id="rCustomerEmail"></span></p>
          </div>
        </div>
        <div class="payment-shipping">
          <div>
            <p><strong>Payment Method</strong></p>
            <p><span id="rPaymentMethod"></span></p>
          </div>
          <div>
            <p><strong>Shipping Method</strong></p>
            <p><span id="rShippingMethod"></span></p>
          </div>
          <div>
            <p><strong>Shipping Price</strong></p>
            <p>RM <span id="rShippingPrice">0</span></p>
          </div>
        </div>
        <table class="items-table">
          <thead>
          <tr>
            <th>No</th>
            <th>Image</th>
            <th>Item</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Total</th>
          </tr>
          </thead>
          <tbody id="itemsList"></tbody>
        </table>
        <div class="totals">
          <p><strong>Subtotal:</strong> RM <span id="rSubtotal">0</span></p>
          <p><strong>Shipping:</strong> RM <span id="rShipTotal">0</span></p>
          <p class="grand-total"><strong>Total:</strong> RM <span id="rTotal">0</span></p>
        </div>
        <div class="remarks">
          <p><strong>Remarks:</strong> <span id="rRemarks">-</span></p>
        </div>
        <div class="footer">
          <p>Che Warie D Katering</p>
          <p>Authorized Signature: ______________________</p>
        </div>
      </div>
    </div>

    <!-- RIGHT: Form Section -->
    <div class="form-section">
      <h2 style="font-size: 12pt; margin: 0 0 10px;">Edit Receipt</h2>
      <details open>
        <summary>üìë Invoice Details</summary>
        <label>Type: 
          <select id="docType" onchange="updateDocType()">
            <option value="receipt">Receipt</option>
            <option value="quotation">Quotation</option>
          </select>
        </label>
        <div style="margin: 10px 0;">
          <strong>Document No:</strong> <span id="docLabel" class="doc-label receipt">Receipt</span><br>
          <input type="text" id="invoiceNo" readonly style="margin-top: 5px; width: 100%;">
        </div>        
        <label>Payment Method: <input type="text" id="paymentMethod"></label>
        <label>Shipping Method: <input type="text" id="shippingMethod"></label>
        <label>Shipping Price: <input type="number" id="shippingPrice" value="0" step="0.01"></label>
      </details>
      <details open>
        <summary>üë§ Bill To</summary>
        <label>Customer History:
          <select id="customerHistory" onchange="loadCustomerFromHistory()">
            <option value="">New Customer</option>
          </select>
        </label>
        <label>Name: <input type="text" id="customerName"></label>
        <label>Address: <textarea id="customerAddress"></textarea></label>
        <label>Tel: <input type="text" id="customerTel"></label>
        <label>Email: <input type="text" id="customerEmail"></label>
        <button id="saveCustomerBtn" onclick="saveOrUpdateCustomer()">Save Customer</button>
        <button id="deleteCustomerBtn" class="danger-btn" onclick="deleteCustomer()" style="display: none;">Delete Customer</button>
      </details>
      <details open>
        <summary>üõí Items</summary>
        <label>Modify Item:
          <select id="modifyItemSelect" onchange="chooseItemToModify()">
            <option value="-1">New Item</option>
          </select>
        </label>
        <label>Item: <input type="text" id="itemName"></label>
        <label>Qty: <input type="number" id="itemQty" value="1" min="1"></label>
        <label>Unit Price: <input type="number" id="itemPrice" value="0" step="0.01"></label>
        <input type="hidden" id="itemImage">
        <button id="addBtn" onclick="addItem()">Add Item</button>
        <button type="button" onclick="openCataloguePopup()">Open Product Catalogue</button>
        <div id="itemEditButtons" style="margin-top:10px;">
          <button onclick="deleteSelectedItem()">Delete Selected Item</button>
        </div>
      </details>
      <details>
        <summary>üìù Remarks</summary>
        <label>Remarks:
          <textarea id="remarks" rows="3" placeholder="Enter any special instructions or notes..."></textarea>
        </label>
      </details>
      <details>
        <summary>üìÅ Recent Invoices</summary>
        <label>Load Receipt:
          <select id="recentInvoices" onchange="loadRecentInvoice()">
            <option value="">Select a receipt...</option>
          </select>
        </label>
        <button onclick="clearAllRecent()" style="font-size:9pt; padding:5px 8px;">üóëÔ∏è Clear All</button>
        <button id="deleteInvoiceBtn" class="danger-btn" onclick="deleteSelectedInvoice()" style="display:none;">Delete Selected</button>
        <button onclick="newReceipt()" style="font-size:9pt; padding:5px 8px;">üÜï New Receipt</button>
      </details>
      <div class="actions">
        <button onclick="savePDF()">üíæ Save PDF & Auto-Save</button>
        <button onclick="printReceipt()">üñ®Ô∏è Print Receipt</button>
        <button onclick="convertQuotationToReceipt()" id="convertBtn" style="display:none; background: #ff9800; margin-top: 10px;">üîÑ Convert to Receipt</button>
      </div>
    </div>
  </div>
</div>

<!-- Tab 2: Sales Dashboard -->
<div id="dashboard" class="tab-content" style="display: none;">
  <div class="dashboard-container">
    <h2>Sales Dashboard</h2>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="card">
        <h3>Weekly Sales</h3>
        <p id="weeklySales">RM 0.00</p>
      </div>
      <div class="card">
        <h3>Monthly Sales</h3>
        <p id="monthlySales">RM 0.00</p>
      </div>
      <div class="card">
        <h3>Total Receipts</h3>
        <p id="totalReceipts">0</p>
      </div>
    </div>

    <!-- Top Selling Items -->
    <details open>
      <summary>üèÜ Top Selling Items</summary>
      <ul id="topItemsList"></ul>
    </details>

    <!-- All Receipts -->
    <details open>
      <summary>üìÑ All Receipts (Click to Load)</summary>
      <ul id="allReceiptsList"></ul>
    </details>

    <!-- Export Button -->
    <div style="margin-top: 20px; text-align: right;">
      <button onclick="exportDashboardPDF()" style="background: #2192F3; padding: 8px 16px; font-size: 10pt;">üìÑ Export Dashboard as PDF</button>
    </div>
  </div>
</div>

<!-- Catalogue Popup -->
<div id="cataloguePopup">
  <input type="hidden" id="catalogueEditIndex" value="-1">
  <button class="close-btn" onclick="closeCataloguePopup()">Close</button>
  <h3>Product Catalogue</h3>
  <label>Search: <input type="text" id="catalogueSearch" oninput="filterCatalogue()" placeholder="Search products..."></label>
  <label>Name: <input type="text" id="catalogueName"></label>
  <label>Price: <input type="number" id="cataloguePrice" step="0.01" placeholder="0.00"></label>
  <label>Detail: <textarea id="catalogueDetail" placeholder="E.g. Nasi Kandar, 500g, Spicy option"></textarea></label>
  <label>Image (optional): 
    <input type="file" id="catalogueImageFile" accept="image/*" onchange="previewCatalogueImage()">
  </label>
  <div style="margin:10px 0;">
    <img id="catalogueImagePreview" src="https://via.placeholder.com/100x100?text=No+Image" 
         alt="Preview" width="100" height="100" style="border:1px solid #ddd;">
  </div>
  <button id="catalogueSubmitBtn" onclick="submitCatalogueItem()">Add to Catalogue</button>
  <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
    <button onclick="exportCatalogueJSON()" style="font-size:9pt; padding:5px 8px;">üíæ Backup Catalogue (JSON)</button>
    <button onclick="exportCatalogueCSV()" style="font-size:9pt; padding:5px 8px;">üìä Export for Excel (CSV)</button>
    <button onclick="importCatalogue()" style="font-size:9pt; padding:5px 8px;">üìÇ Import Catalogue</button>
    <input type="file" id="importFile" accept=".json,.csv" style="display:none" onchange="handleImport()">
  </div>
  <div id="catalogueGallery"></div>
</div>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  let items = [];
  let editIndex = -1;
  let catalogue = [];
  let customers = [];
  let editCustomerIndex = -1;
  let savedReceipts = [];
  function initDocType() {
    document.getElementById("docType").value = "receipt";
    updateDocType();
  }
  // ========== TABS ==========
  function openTab(evt, tabName) {
    const tabcontent = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    const tablinks = document.getElementsByClassName("tab-btn");
    for (let i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    if (evt) evt.currentTarget.className += " active";

    if (tabName === 'dashboard') {
      renderDashboard();
    }
  }

  // ========== LOAD ON STARTUP ==========
  window.onload = () => {
    document.getElementById("invoiceDate").valueAsDate = new Date();
    document.getElementById("catalogueImagePreview").src = "https://via.placeholder.com/100x100?text=No+Image";

    const savedCatalogue = localStorage.getItem("cheWarieCatalogue");
    if (savedCatalogue) {
      catalogue = JSON.parse(savedCatalogue);
    }

    const savedCustomers = localStorage.getItem("cheWarieCustomers");
    if (savedCustomers) {
      customers = JSON.parse(savedCustomers);
      renderCustomerHistory();
    }

    const receipts = localStorage.getItem("cheWarieReceipts");
    if (receipts) {
      savedReceipts = JSON.parse(receipts);
      renderRecentInvoices();
    }

    renderModifySelect();
    updateReceiptInfo();
    renderCatalogue();

    // ‚úÖ Initialize document type FIRST
    initDocType();
  };

  // ========== CUSTOMER FUNCTIONS ==========
  function renderCustomerHistory() {
    const select = document.getElementById("customerHistory");
    select.innerHTML = '<option value="">New Customer</option>';
    customers.forEach((cust, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = cust.name;
      select.appendChild(opt);
    });
  }

  function loadCustomerFromHistory() {
  const index = document.getElementById("customerHistory").value;
  if (index === "") {
    clearCustomerForm();
    editCustomerIndex = -1;
    document.getElementById("saveCustomerBtn").textContent = "Save Customer";
    document.getElementById("deleteCustomerBtn").style.display = "none";
  } else {
    const cust = customers[index];
    document.getElementById("customerName").value = cust.name;
    document.getElementById("customerAddress").value = cust.address || "";
    document.getElementById("customerTel").value = cust.tel || "";
    document.getElementById("customerEmail").value = cust.email || "";
    editCustomerIndex = parseInt(index);
    document.getElementById("saveCustomerBtn").textContent = "Update Customer";
    document.getElementById("deleteCustomerBtn").style.display = "inline-block";
  }
  updateReceiptInfo(); 
}

  function clearCustomerForm() {
    document.getElementById("customerName").value = "";
    document.getElementById("customerAddress").value = "";
    document.getElementById("customerTel").value = "";
    document.getElementById("customerEmail").value = "";
  }

  function saveOrUpdateCustomer() {
  const name = document.getElementById("customerName").value.trim();
  if (!name) return alert("Customer name is required.");

  const customer = {
    name: document.getElementById("customerName").value,
    address: document.getElementById("customerAddress").value,
    tel: document.getElementById("customerTel").value,
    email: document.getElementById("customerEmail").value
  };

  if (editCustomerIndex === -1) {
    customers.push(customer);
  } else {
    customers[editCustomerIndex] = customer;
  }

  localStorage.setItem("cheWarieCustomers", JSON.stringify(customers));
  renderCustomerHistory();
  updateReceiptInfo(); // ‚úÖ Sync preview
}

  function deleteCustomer() {
    if (editCustomerIndex === -1) return;
    const name = customers[editCustomerIndex].name;
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
    customers.splice(editCustomerIndex, 1);
    localStorage.setItem("cheWarieCustomers", JSON.stringify(customers));
    renderCustomerHistory();
    clearCustomerForm();
    document.getElementById("customerHistory").value = "";
    document.getElementById("saveCustomerBtn").textContent = "Save Customer";
    document.getElementById("deleteCustomerBtn").style.display = "none";
    editCustomerIndex = -1;
    updateReceiptInfo();
  }

  // ========== ITEM FUNCTIONS ==========
  function clearItemForm() {
    document.getElementById("itemName").value = "";
    document.getElementById("itemQty").value = 1;
    document.getElementById("itemPrice").value = 0;
    document.getElementById("itemImage").value = "";
  }

  function renderModifySelect() {
    const select = document.getElementById("modifyItemSelect");
    let options = '<option value="-1">New Item</option>';
    items.forEach((item, i) => {
      options += `<option value="${i}">${item.name} (${item.qty})</option>`;
    });
    select.innerHTML = options;
  }

  function chooseItemToModify() {
    const index = parseInt(document.getElementById("modifyItemSelect").value);
    if (isNaN(index) || index < 0 || index >= items.length) {
      clearItemForm();
      editIndex = -1;
      document.getElementById("addBtn").textContent = "Add Item";
      return;
    }

    const item = items[index];
    document.getElementById("itemName").value = item.name;
    document.getElementById("itemQty").value = item.qty;
    document.getElementById("itemPrice").value = item.price;
    document.getElementById("itemImage").value = item.image || "";
    editIndex = index;
    document.getElementById("addBtn").textContent = "Update Item";
  }

  function deleteSelectedItem() {
    if (editIndex === -1) return alert("Select an item first");
    items.splice(editIndex, 1);
    editIndex = -1;
    renderItems();
    renderModifySelect();
    chooseItemToModify();
  }

  function addItem() {
    const name = document.getElementById("itemName").value.trim();
    const qty = parseInt(document.getElementById("itemQty").value);
    const price = parseFloat(document.getElementById("itemPrice").value);
    const image = document.getElementById("itemImage").value || "";
    if (!name || qty <= 0 || isNaN(price) || price < 0) {
      return alert("Please fill in all item fields correctly.");
    }
    if (editIndex === -1) {
      items.push({ name, qty, price, image });
    } else {
      items[editIndex] = { name, qty, price, image };
      editIndex = -1;
    }
    clearItemForm();
    renderItems();
    renderModifySelect();
    document.getElementById("addBtn").textContent = "Add Item";
  }

  function renderItems() {
    const tbody = document.getElementById("itemsList");
    tbody.innerHTML = "";
    let subtotal = 0;
    items.forEach((item, i) => {
      const total = item.qty * item.price;
      subtotal += total;
      const imgTag = item.image ? `<img src="${item.image}" width="45" height="45">` : "";
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i + 1}</td>
        <td>${imgTag}</td>
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>RM ${item.price.toFixed(2)}</td>
        <td>RM ${total.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });
    const shipping = parseFloat(document.getElementById("shippingPrice").value) || 0;
    document.getElementById("rSubtotal").textContent = subtotal.toFixed(2);
    document.getElementById("rShipTotal").textContent = shipping.toFixed(2);
    document.getElementById("rTotal").textContent = (subtotal + shipping).toFixed(2);
    updateReceiptInfo();
  }

  function updateReceiptInfo() {
  document.getElementById("rInvoiceNo").textContent = document.getElementById("invoiceNo").value || "-";
  document.getElementById("rInvoiceDate").textContent = document.getElementById("invoiceDate").value || "-";
  document.getElementById("rCustomerName").textContent = document.getElementById("customerName").value || "-";
  document.getElementById("rCustomerAddress").textContent = document.getElementById("customerAddress").value || "-";
  document.getElementById("rCustomerTel").textContent = document.getElementById("customerTel").value || "-";
  document.getElementById("rCustomerEmail").textContent = document.getElementById("customerEmail").value || "-";

  document.getElementById("rPaymentMethod").textContent = document.getElementById("paymentMethod").value || "-";
  document.getElementById("rShippingMethod").textContent = document.getElementById("shippingMethod").value || "-";
  document.getElementById("rShippingPrice").textContent = (parseFloat(document.getElementById("shippingPrice").value) || 0).toFixed(2);

  document.getElementById("rRemarks").textContent = document.getElementById("remarks").value || "-";

  // Update items and totals
  renderItems();
}

  document.body.addEventListener("input", function(e) {
  const id = e.target.id;
  const watched = [
    "customerName", "customerAddress", "customerTel", "customerEmail",
    "paymentMethod", "shippingMethod", "shippingPrice", "remarks",
    "invoiceNo", "invoiceDate", "docType"
  ];
  if (watched.includes(id)) {
    updateReceiptInfo();
  }
}); // ‚úÖ Fixed: Added closing }

// Also trigger on select changes (for dropdowns)
document.body.addEventListener("change", function(e) {
  if (["customerHistory", "docType", "modifyItemSelect"].includes(e.target.id)) {
    updateReceiptInfo();
  }
}); // ‚úÖ Fixed: Added closing }
  
  // ========== SAVE PDF ==========
  function savePDF() {
    const receipt = document.getElementById("receipt");
    const clone = receipt.cloneNode(true);
    clone.style.width = "210mm";
    clone.style.minHeight = "297mm";
    clone.style.padding = "25.4mm";
    clone.style.boxSizing = "border-box";
    clone.style.position = "relative";
    clone.style.margin = "0 auto";
    const imgs = clone.querySelectorAll("img");
    imgs.forEach(img => {
      if (img.src.includes("placeholder")) return;
      img.crossOrigin = "anonymous";
    });
    html2pdf()
      .from(clone)
      .set({
        margin: 0,
        filename: `Receipt_${document.getElementById("invoiceNo").value || "Draft"}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3, useCORS: true, scrollY: 0, scrollX: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pageBreak: { mode: ['avoid-last', 'css'] }
      })
      .save();
    saveCurrentReceipt();
  }

  // ========== AUTO-SAVE & RECENT INVOICES ==========
  function newReceipt() {
  document.getElementById("invoiceDate").valueAsDate = new Date();
  document.getElementById("customerName").value = "";
  document.getElementById("customerAddress").value = "";
  document.getElementById("customerTel").value = "";
  document.getElementById("customerEmail").value = "";
  document.getElementById("paymentMethod").value = "";
  document.getElementById("shippingMethod").value = "";
  document.getElementById("shippingPrice").value = "";
  document.getElementById("remarks").value = "";
  document.getElementById("customerHistory").value = "";
  document.getElementById("saveCustomerBtn").textContent = "Save Customer";
  document.getElementById("deleteCustomerBtn").style.display = "none";

  // Reset items
  items = [];
  editIndex = -1;
  renderItems();
  renderModifySelect();
  document.getElementById("addBtn").textContent = "Add Item";

  // Reset document type
  document.getElementById("docType").value = "receipt";
  updateDocType(); // This regenerates invoice number and updates UI

  // Clear any old state
  editCustomerIndex = -1;

  alert("‚úÖ New receipt started with auto-generated invoice number.");
}
  function saveCurrentReceipt() {
    const receiptData = {
      invoiceNo: document.getElementById("invoiceNo").value,
      invoiceDate: document.getElementById("invoiceDate").value,
      customerName: document.getElementById("customerName").value,
      items: [...items],
      subtotal: document.getElementById("rSubtotal").textContent,
      shipping: document.getElementById("rShipTotal").textContent,
      total: document.getElementById("rTotal").textContent,
      timestamp: new Date().toISOString(),
      docType: document.getElementById("docType").value 
    };
    const exists = savedReceipts.findIndex(r => r.invoiceNo === receiptData.invoiceNo);
    if (exists !== -1) {
      savedReceipts[exists] = receiptData;
    } else {
      savedReceipts.unshift(receiptData);
    }
    if (savedReceipts.length > 50) {
      savedReceipts = savedReceipts.slice(0, 50);
    }
    localStorage.setItem("cheWarieReceipts", JSON.stringify(savedReceipts));
    renderRecentInvoices();
  }

  function renderRecentInvoices() {
    const select = document.getElementById("recentInvoices");
    select.innerHTML = '<option value="">Select a receipt...</option>';
    savedReceipts.forEach((r, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `#${r.invoiceNo} - ${r.customerName} (RM ${r.total})`;
      select.appendChild(opt);
    });
  }

  function loadRecentInvoice() {
    const index = document.getElementById("recentInvoices").value;
    if (index === "") {
      document.getElementById("deleteInvoiceBtn").style.display = "none";
      return;
    }
    document.getElementById("deleteInvoiceBtn").style.display = "inline-block";
    const r = savedReceipts[index];
    document.getElementById("invoiceNo").value = r.invoiceNo;
    document.getElementById("invoiceDate").value = r.invoiceDate;
    document.getElementById("customerName").value = r.customerName;
    const custIndex = customers.findIndex(c => c.name === r.customerName);
    if (custIndex !== -1) {
      document.getElementById("customerAddress").value = customers[custIndex].address || "";
      document.getElementById("customerTel").value = customers[custIndex].tel || "";
      document.getElementById("customerEmail").value = customers[custIndex].email || "";
      document.getElementById("customerHistory").value = custIndex;
      document.getElementById("saveCustomerBtn").textContent = "Update Customer";
      document.getElementById("deleteCustomerBtn").style.display = "inline-block";
    } else {
      document.getElementById("customerAddress").value = "";
      document.getElementById("customerTel").value = "";
      document.getElementById("customerEmail").value = "";
      document.getElementById("customerHistory").value = "";
      document.getElementById("saveCustomerBtn").textContent = "Save Customer";
      document.getElementById("deleteCustomerBtn").style.display = "none";
    }
    // Restore document type
    if (r.invoiceNo.startsWith("QTN-")) {
      document.getElementById("docType").value = "quotation";
    } else {
      document.getElementById("docType").value = "receipt";
    }
    updateDocType(); // This updates label, button, and number
    items = r.items.map(item => ({...item}));
    // Set document type based on prefix
    if (r.invoiceNo.startsWith("QTN-")) {
      document.getElementById("docType").value = "quotation";
    } else {
      document.getElementById("docType").value = "receipt";
    }
    // Restore document type
    document.getElementById("docType").value = r.docType || "receipt";
    updateDocType();
    renderItems();
    renderModifySelect();
    updateReceiptInfo();
    alert(`‚úÖ Loaded receipt #${r.invoiceNo}`);
  }

  function clearAllRecent() {
    if (confirm("Are you sure you want to delete all saved receipts?")) {
      savedReceipts = [];
      localStorage.removeItem("cheWarieReceipts");
      renderRecentInvoices();
      document.getElementById("recentInvoices").value = "";
    }
  }

  function deleteSelectedInvoice() {
    const select = document.getElementById("recentInvoices");
    const index = select.value;
    if (index === "") return alert("Please select a receipt to delete.");
    const invoice = savedReceipts[index];
    if (!confirm(`Are you sure you want to delete invoice #${invoice.invoiceNo}?`)) return;
    savedReceipts.splice(index, 1);
    localStorage.setItem("cheWarieReceipts", JSON.stringify(savedReceipts));
    renderRecentInvoices();
    select.value = "";
    document.getElementById("deleteInvoiceBtn").style.display = "none";
    alert(`‚úÖ Invoice #${invoice.invoiceNo} deleted.`);
  }

  // ========== PRINT FUNCTION ==========
  function printReceipt() {
    const receipt = document.getElementById("receipt");
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>Print Receipt</title>
          <style>
            @page {
              size: A4;
              margin: 25.4mm;
            }
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
            }
            #receipt {
              width: 210mm;
              min-height: 297mm;
              padding: 25.4mm;
              box-sizing: border-box;
              margin: 0 auto;
              font-size: 10pt;
            }
            .receipt-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            }
            .logo {
              width: 130px;
            }
            .receipt-title {
              text-align: center;
              margin: 15px 0;
              font-size: 11pt;
              font-weight: bold;
            }
            .items-table {
              width: 100%;
              border-collapse: collapse;
              margin: 12px 0;
              page-break-inside: avoid;
            }
            .items-table th, .items-table td {
              border: 1px solid #ddd;
              padding: 5px;
              text-align: center;
            }
            .totals {
              text-align: right;
              margin-top: 15px;
            }
            .footer {
              text-align: center;
              margin-top: 35px;
            }
          </style>
        </head>
        <body>
          ${receipt.outerHTML}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.addEventListener('load', () => {
      printWindow.print();
    });
  }

  // ========== SALES DASHBOARD ==========
  function renderDashboard() {
    const receipts = JSON.parse(localStorage.getItem("cheWarieReceipts")) || [];
    if (receipts.length === 0) {
      document.getElementById("weeklySales").textContent = "RM 0.00";
      document.getElementById("monthlySales").textContent = "RM 0.00";
      document.getElementById("totalReceipts").textContent = "0";
      document.getElementById("topItemsList").innerHTML = "<li>No data</li>";
      document.getElementById("allReceiptsList").innerHTML = "<li>No receipts</li>";
      return;
    }

    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

    let weeklySales = 0;
    let monthlySales = 0;
    const itemSales = {};

    receipts.forEach(r => {
      const date = new Date(r.timestamp);
      const amount = parseFloat(r.total);

      if (date >= oneWeekAgo) weeklySales += amount;
      if (date >= oneMonthAgo) monthlySales += amount;

      r.items.forEach(item => {
        if (!itemSales[item.name]) {
          itemSales[item.name] = { name: item.name, qty: 0 };
        }
        itemSales[item.name].qty += item.qty;
      });
    });

    const topItems = Object.values(itemSales)
      .sort((a, b) => b.qty - a.qty)
      .slice(0, 10);

    document.getElementById("weeklySales").textContent = `RM ${weeklySales.toFixed(2)}`;
    document.getElementById("monthlySales").textContent = `RM ${monthlySales.toFixed(2)}`;
    document.getElementById("totalReceipts").textContent = receipts.length;

    // Top Items
    const topList = document.getElementById("topItemsList");
    topList.innerHTML = "";
    topItems.forEach(item => {
      const li = document.createElement("li");
      li.textContent = `${item.name} ‚Äî ${item.qty} units`;
      topList.appendChild(li);
    });

    // All Receipts
    const allList = document.getElementById("allReceiptsList");
    allList.innerHTML = "";
    [...receipts].reverse().forEach(r => {
      const li = document.createElement("li");
      const date = new Date(r.invoiceDate || r.timestamp).toLocaleDateString();
      li.textContent = `#${r.invoiceNo} ‚Äî ${r.customerName} (RM ${r.total}) ‚Äî ${date}`;
      li.onclick = () => previewReceipt(r);
      allList.appendChild(li);
    });
  }

  function previewReceipt(receipt) {
    openTab(null, 'generator');
    document.getElementById("invoiceNo").value = receipt.invoiceNo;
    document.getElementById("invoiceDate").value = receipt.invoiceDate;
    document.getElementById("customerName").value = receipt.customerName;
    const custIndex = customers.findIndex(c => c.name === receipt.customerName);
    if (custIndex !== -1) {
      document.getElementById("customerAddress").value = customers[custIndex].address || "";
      document.getElementById("customerTel").value = customers[custIndex].tel || "";
      document.getElementById("customerEmail").value = customers[custIndex].email || "";
      document.getElementById("customerHistory").value = custIndex;
    } else {
      document.getElementById("customerAddress").value = "";
      document.getElementById("customerTel").value = "";
      document.getElementById("customerEmail").value = "";
      document.getElementById("customerHistory").value = "";
    }
    items = receipt.items.map(item => ({...item}));
    renderItems();
    renderModifySelect();
    updateReceiptInfo();
    alert(`‚úÖ Loaded receipt #${receipt.invoiceNo}`);
  }

  // ========== EXPORT DASHBOARD TO PDF ==========
  function exportDashboardPDF() {
    const receipts = JSON.parse(localStorage.getItem("cheWarieReceipts")) || [];
    if (receipts.length === 0) {
      return alert("No receipts to export.");
    }

    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

    let weeklySales = 0;
    let monthlySales = 0;
    const itemSales = {};

    receipts.forEach(r => {
      const date = new Date(r.timestamp);
      const amount = parseFloat(r.total);

      if (date >= oneWeekAgo) weeklySales += amount;
      if (date >= oneMonthAgo) monthlySales += amount;

      r.items.forEach(item => {
        if (!itemSales[item.name]) {
          itemSales[item.name] = { name: item.name, qty: 0 };
        }
        itemSales[item.name].qty += item.qty;
      });
    });

    const topItems = Object.values(itemSales)
      .sort((a, b) => b.qty - a.qty)
      .slice(0, 10);

    const pdfContent = document.createElement("div");
    pdfContent.className = "dashboard-pdf";
    pdfContent.innerHTML = `
      <h2>Sales Dashboard Report</h2>
      <p><strong>Generated on:</strong> ${new Date().toLocaleString()}</p>
      <p><strong>Total Receipts:</strong> ${receipts.length}</p>
      <div class="card"><strong>Weekly Sales:</strong> RM ${weeklySales.toFixed(2)}</div>
      <div class="card"><strong>Monthly Sales:</strong> RM ${monthlySales.toFixed(2)}</div>
      <h3>üèÜ Top Selling Items</h3>
      <ul>
        ${topItems.map(item => `<li>${item.name} ‚Äî ${item.qty} units sold</li>`).join("")}
      </ul>
      <h3>üìÑ Recent Receipts</h3>
      <ul>
        ${receipts.slice(-10).reverse().map(r => {
          const date = new Date(r.invoiceDate || r.timestamp).toLocaleDateString();
          return `<li>#${r.invoiceNo} ‚Äî ${r.customerName} (RM ${r.total}) ‚Äî ${date}</li>`;
        }).join("")}
      </ul>
      <div style="margin-top: 40px; text-align: center; font-size: 9pt; color: #666;">
        <p>Che Warie D Katering</p>
        <p>Authorized by: ______________________</p>
      </div>
    `;

    html2pdf()
      .from(pdfContent)
      .set({
        margin: 0,
        filename: `Sales_Dashboard_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      })
      .save();
  }

  // ========== CATALOGUE FUNCTIONS ==========
  function openCataloguePopup() {
    document.getElementById("cataloguePopup").style.display = "block";
  }

  function closeCataloguePopup() {
    document.getElementById("cataloguePopup").style.display = "none";
  }

  function previewCatalogueImage() {
    const fileInput = document.getElementById("catalogueImageFile");
    const preview = document.getElementById("catalogueImagePreview");
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
      };
      reader.readAsDataURL(fileInput.files[0]);
    }
  }

  function submitCatalogueItem() {
    const name = document.getElementById("catalogueName").value.trim();
    const priceStr = document.getElementById("cataloguePrice").value.trim();
    const price = parseFloat(priceStr);
    const detail = document.getElementById("catalogueDetail").value;
    const image = document.getElementById("catalogueImagePreview").src;

    if (!name) return alert("Product name is required.");
    if (!priceStr || isNaN(price) || price < 0) return alert("Valid price is required.");

    const index = parseInt(document.getElementById("catalogueEditIndex").value);
    if (index >= 0 && index < catalogue.length) {
      catalogue[index] = { name, price, detail, image };
    } else {
      catalogue.push({ name, price, detail, image });
    }

    saveCatalogueToStorage();
    renderCatalogue();
    resetCatalogueForm();
  }

  function saveCatalogueToStorage() {
    localStorage.setItem("cheWarieCatalogue", JSON.stringify(catalogue));
  }

  function resetCatalogueForm() {
    document.getElementById("catalogueName").value = "";
    document.getElementById("cataloguePrice").value = "";
    document.getElementById("catalogueDetail").value = "";
    document.getElementById("catalogueImageFile").value = "";
    document.getElementById("catalogueImagePreview").src = "https://via.placeholder.com/100x100?text=No+Image";
    document.getElementById("catalogueEditIndex").value = "-1";
    document.getElementById("catalogueSubmitBtn").textContent = "Add to Catalogue";
  }

  function filterCatalogue() {
    const query = document.getElementById("catalogueSearch").value.toLowerCase();
    const gallery = document.getElementById("catalogueGallery");
    const items = gallery.querySelectorAll("div");
    items.forEach(item => {
      const name = item.querySelector("p strong").textContent.toLowerCase();
      const detail = item.querySelector("p:nth-child(3)").textContent.toLowerCase();
      const matches = name.includes(query) || detail.includes(query);
      item.style.display = matches ? "block" : "none";
    });
  }

  function renderCatalogue() {
    const gallery = document.getElementById("catalogueGallery");
    gallery.innerHTML = "";
    catalogue.forEach((item, i) => {
      const div = document.createElement("div");
      div.innerHTML = `
        <img src="${item.image || 'https://via.placeholder.com/100x100?text=No+Image'}" alt="${item.name}" width="100" height="100">
        <p><strong>${item.name}</strong></p>
        <p>RM ${item.price.toFixed(2)}</p>
        <p>${item.detail || "-"}</p>
        <button onclick="selectCatalogueItem(${i})">Add</button>
        <button onclick="editCatalogueItem(${i})">Edit</button>
        <button onclick="deleteCatalogueItem(${i})">Delete</button>
      `;
      gallery.appendChild(div);
    });
    filterCatalogue();
  }

  function editCatalogueItem(index) {
    const item = catalogue[index];
    document.getElementById("catalogueName").value = item.name;
    document.getElementById("cataloguePrice").value = item.price;
    document.getElementById("catalogueDetail").value = item.detail;
    document.getElementById("catalogueImagePreview").src = item.image || "https://via.placeholder.com/100x100?text=No+Image";
    document.getElementById("catalogueImageFile").value = "";
    document.getElementById("catalogueEditIndex").value = index;
    document.getElementById("catalogueSubmitBtn").textContent = "Update";
  }

  function deleteCatalogueItem(index) {
    if (confirm("Are you sure you want to delete this product?")) {
      catalogue.splice(index, 1);
      renderCatalogue();
      saveCatalogueToStorage();
    }
  }

  function selectCatalogueItem(index) {
    const item = catalogue[index];
    document.getElementById("itemName").value = item.name;
    document.getElementById("itemPrice").value = item.price;
    document.getElementById("itemImage").value = item.image || "";
    editIndex = -1;
    document.getElementById("modifyItemSelect").value = "-1";
    document.getElementById("addBtn").textContent = "Add Item";
    closeCataloguePopup();
  }

  // Make popup draggable
  function dragElement(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    const header = elmnt;
    header.onmousedown = dragMouseDown;
    function dragMouseDown(e) {
      e = e || window.event;
      const target = e.target;
      if (["INPUT", "TEXTAREA", "BUTTON"].includes(target.tagName) || target.classList.contains("close-btn")) return;
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }
  dragElement(document.getElementById("cataloguePopup"));


  // === IMPORT / EXPORT FUNCTIONS ===
  function exportCatalogueJSON() {
    const dataStr = JSON.stringify(catalogue);
    downloadFile("che-warie-catalogue.json", dataStr, "application/json");
  }

  function exportCatalogueCSV() {
    let csv = "Name,Price,Detail\n";
    catalogue.forEach(item => {
      const row = `"${item.name}",${item.price},"${(item.detail || "").replace(/"/g, '""')}"`;
      csv += row + "\n";
    });
    downloadFile("che-warie-catalogue.csv", csv, "text/csv");
  }

  function importCatalogue() {
    document.getElementById("importFile").click();
  }

  function handleImport() {
    const file = document.getElementById("importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      if (file.name.endsWith(".json")) {
        try {
          const imported = JSON.parse(content);
          if (Array.isArray(imported)) {
            catalogue = imported;
            saveCatalogueToStorage();
            renderCatalogue();
            alert("‚úÖ Catalogue imported successfully!");
          } else {
            alert("‚ùå Invalid format. Expected array.");
          }
        } catch (err) {
          alert("‚ùå Invalid JSON file.");
        }
      } else if (file.name.endsWith(".csv")) {
        parseCSV(content);
      }
    };
    reader.readAsText(file);
  }

  function parseCSV(csv) {
    const lines = csv.split("\n").filter(l => l.trim());
    const imported = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      if (cols.length >= 2) {
        const name = cols[0].replace(/^"|"$/g, "");
        const price = parseFloat(cols[1]);
        const detail = cols.slice(2).join(",").replace(/^"|"$/g, "");
        if (!isNaN(price)) {
          imported.push({ name, price, detail, image: "" });
        }
      }
    }
    if (imported.length > 0) {
      catalogue = catalogue.concat(imported);
      saveCatalogueToStorage();
      renderCatalogue();
      alert(`‚úÖ Imported ${imported.length} items from CSV (images not included)`);
    } else {
      alert("‚ùå No valid items found in CSV.");
    }
  }

  function downloadFile(filename, data, type) {
    const blob = new Blob([data], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
  // ========== INVOICE NUMBER GENERATOR ==========
function generateInvoiceNumber() {
  const now = new Date();
  const year = now.getFullYear();
  
  // Get all saved receipts
  const receipts = JSON.parse(localStorage.getItem("cheWarieReceipts")) || [];
  
  // Filter receipts from current year
  const currentYearReceipts = receipts.filter(r => r.invoiceNo && r.invoiceNo.startsWith(`INV-${year}-`));
  
  // Find highest serial number
  let maxSerial = 0;
  currentYearReceipts.forEach(r => {
    const match = r.invoiceNo.match(/INV-\d{4}-(\d+)/);
    if (match) {
      const serial = parseInt(match[1]);
      if (serial > maxSerial) maxSerial = serial;
    }
  });
  
  // Generate new serial (increment by 1)
  const newSerial = (maxSerial + 1).toString().padStart(5, '0');
  
  return `INV-${year}-${newSerial}`;
}
// ========== DOCUMENT TYPE (Receipt vs Quotation) ==========
function updateDocType() {
  const type = document.getElementById("docType").value;
  const title = document.querySelector(".receipt-title");
  const invoiceNo = document.getElementById("invoiceNo");

  // Update header
  title.textContent = type === "receipt" ? "RECEIPT" : "QUOTATION";

  // Update label
  const label = document.getElementById("docLabel");
  label.textContent = type === "receipt" ? "Receipt" : "Quotation";
  label.className = `doc-label ${type}`;

  // Show/hide convert button
  document.getElementById("convertBtn").style.display = type === "quotation" ? "inline-block" : "none";

  // ‚úÖ Generate new number with correct prefix
  const prefix = type === "receipt" ? "INV" : "QTN";
  const now = new Date();
  const year = now.getFullYear();

  const receipts = JSON.parse(localStorage.getItem("cheWarieReceipts")) || [];
  const currentTypeDocs = receipts.filter(r => r.invoiceNo && r.invoiceNo.startsWith(`${prefix}-${year}-`));

  let maxSerial = 0;
  currentTypeDocs.forEach(r => {
    const match = r.invoiceNo.match(new RegExp(`${prefix}-\\d{4}-(\\d+)`));
    if (match) {
      const serial = parseInt(match[1]);
      if (serial > maxSerial) maxSerial = serial;
    }
  });

  const newSerial = (maxSerial + 1).toString().padStart(5, '0');
  invoiceNo.value = `${prefix}-${year}-${newSerial}`;

  updateReceiptInfo();
}

// ========== CONVERT QUOTATION TO RECEIPT ==========
function convertQuotationToReceipt() {
  if (!document.getElementById("invoiceNo").value.startsWith("QTN-")) {
    return alert("Only quotations can be converted to receipts.");
  }

  if (!confirm("Convert this quotation to a receipt? This will generate a new receipt number.")) return;

  const oldNo = document.getElementById("invoiceNo").value;
  
  // Change type to receipt
  document.getElementById("docType").value = "receipt";
  
  // Regenerate number (will now be INV-...)
  updateDocType(); // This updates the number and UI
  
  alert(`‚úÖ Converted from ${oldNo} to ${document.getElementById("invoiceNo").value}`);
}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => console.log('SW registered'))
      .catch(error => console.log('SW registration failed', error));
  });
}
</script>
</body>
</html>
